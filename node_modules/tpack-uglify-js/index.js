
var UglifyJS = require('uglify-js');
var Lang = require('tealweb/lang');

/**
 * JS 压缩插件。
 * @this 支持扩展以下字段：
 * * @property {Boolean|Object} [sourceMap=false] 是否生成 SourceMap。如果为对象，则内部配置 SourceMap 的相关配置：
 * * * @property {Boolean} [sourceMapFileInline=false] 是否内联 SourceMap。
 * @param {ProjectFile} file 当前正在生成的文件。可用于获取文件内容和路径。
 * @param {ProjectBuilder} builder 当前生成器。存储生成的相关配置。
 * @returns {Array|String} 返回生成的内容数组。 
 */
module.exports = function (file, builder) {
    var options = Object.assign({
        fromString: true,
        output: {
            comments: /!|@preserve|@cc_on|\bMIT\b|\bMPL\b|\bGPL\b|\bBSD\b|\bISCL\b|\(c\)|License|Copyright/mi
        }
    }, this);

    // TODO: 添加 sourceMap 支持：https://github.com/mishoo/UglifyJS2

    // 如果存在第二地址，则第二地址是 map 文件路径。
    if (file.relatedFiles) {
        throw "SourceMap is not supported yet.";
        options.outSourceMap = Path.basename(file.relatedFiles[0].dest);
    }

    var result = UglifyJS.minify(file.content, options);

    return result.code;
};
